---
- name: Configure Bastion Host
  hosts: bastion
  become: yes
  vars:
    aws_region: us-east-1
    cluster_name: task-manager-eks
  
  tasks:
    - name: Update all packages
      yum:
        name: "*"
        state: latest
        update_cache: yes
    
    - name: Install required packages
      yum:
        name:
          - git
          - docker
          - jq
          - curl
          - wget
          - unzip
          - python3-pip
          - mysql
          - postgresql
        state: present
    
    - name: Install AWS CLI v2
      shell: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip -o awscliv2.zip
        ./aws/install
        rm -rf awscliv2.zip aws/
      args:
        creates: /usr/local/bin/aws
    
    - name: Install kubectl
      shell: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        mv kubectl /usr/local/bin/
      args:
        creates: /usr/local/bin/kubectl
    
    - name: Install eksctl
      shell: |
        curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
        mv /tmp/eksctl /usr/local/bin
      args:
        creates: /usr/local/bin/eksctl
    
    - name: Install Helm
      shell: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        chmod +x get_helm.sh
        ./get_helm.sh
        rm get_helm.sh
      args:
        creates: /usr/local/bin/helm
    
    - name: Install Terraform
      shell: |
        wget https://releases.hashicorp.com/terraform/1.5.0/terraform_1.5.0_linux_amd64.zip
        unzip terraform_1.5.0_linux_amd64.zip
        mv terraform /usr/local/bin/
        rm terraform_1.5.0_linux_amd64.zip
      args:
        creates: /usr/local/bin/terraform
    
    - name: Install Ansible
      pip:
        name:
          - ansible
          - boto3
          - botocore
        state: present
    
    - name: Create .kube directory
      file:
        path: /home/ec2-user/.kube
        state: directory
        owner: ec2-user
        group: ec2-user
    
    - name: Configure kubectl for EKS
      shell: |
        aws eks update-kubeconfig --region {{ aws_region }} --name {{ cluster_name }} --kubeconfig /home/ec2-user/.kube/config
      become_user: ec2-user
    
    - name: Install and configure Docker
      service:
        name: docker
        state: started
        enabled: yes
    
    - name: Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes
    
    - name: Create scripts directory
      file:
        path: /home/ec2-user/scripts
        state: directory
        owner: ec2-user
        group: ec2-user
    
    - name: Copy health check script
      copy:
        src: scripts/health-check.sh
        dest: /home/ec2-user/scripts/health-check.sh
        mode: '0755'
        owner: ec2-user
        group: ec2-user
    
    - name: Setup cron for health checks
      cron:
        name: "health check"
        minute: "*/5"
        job: "/home/ec2-user/scripts/health-check.sh >> /var/log/health-check.log 2>&1"
        user: ec2-user

- name: Configure Worker Nodes
  hosts: kubernetes_workers
  become: yes
  vars:
    node_role: worker
  
  tasks:
    - name: Update all packages
      yum:
        name: "*"
        state: latest
        update_cache: yes
    
    - name: Install essential tools
      yum:
        name:
          - curl
          - wget
          - git
          - jq
          - htop
          - iotop
          - netstat
          - telnet
          - bind-utils
        state: present
    
    - name: Disable SELinux
      selinux:
        state: disabled
    
    - name: Disable swap
      shell: |
        swapoff -a
        sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
    
    - name: Load kernel modules
      copy:
        content: |
          overlay
          br_netfilter
        dest: /etc/modules-load.d/k8s.conf
    
    - name: Configure sysctl
      copy:
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1
        dest: /etc/sysctl.d/k8s.conf
    
    - name: Apply sysctl settings
      shell: sysctl --system
    
    - name: Install containerd
      shell: |
        yum install -y yum-utils
        yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
        yum install -y containerd.io
      args:
        creates: /usr/bin/containerd
    
    - name: Configure containerd
      shell: |
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
    
    - name: Start containerd
      systemd:
        name: containerd
        state: started
        enabled: yes
    
    - name: Install kubelet
      shell: |
        cat <<EOF > /etc/yum.repos.d/kubernetes.repo
        [kubernetes]
        name=Kubernetes
        baseurl=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/
        enabled=1
        gpgcheck=1
        gpgkey=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/repodata/repomd.xml.key
        EOF
        yum install -y kubelet kubeadm
      args:
        creates: /usr/bin/kubelet
    
    - name: Start kubelet
      systemd:
        name: kubelet
        state: started
        enabled: yes
    
    - name: Install AWS SSM Agent
      shell: |
        yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm
      args:
        creates: /usr/bin/amazon-ssm-agent
    
    - name: Install CloudWatch Agent
      shell: |
        yum install -y amazon-cloudwatch-agent
      args:
        creates: /usr/bin/amazon-cloudwatch-agent-ctl
    
    - name: Configure CloudWatch Agent
      copy:
        content: |
          {
            "agent": {
              "metrics_collection_interval": 60,
              "run_as_user": "root"
            },
            "logs": {
              "logs_collected": {
                "files": {
                  "collect_list": [
                    {
                      "file_path": "/var/log/messages",
                      "log_group_name": "/aws/eks/{{ cluster_name }}/worker",
                      "log_stream_name": "{instance_id}",
                      "timestamp_format": "%b %d %H:%M:%S"
                    },
                    {
                      "file_path": "/var/log/containers/*.log",
                      "log_group_name": "/aws/eks/{{ cluster_name }}/containers",
                      "log_stream_name": "{instance_id}",
                      "timestamp_format": "%Y-%m-%dT%H:%M:%S.%fZ"
                    }
                  ]
                }
              }
            }
          }
        dest: /opt/aws/amazon-cloudwatch-agent/etc/config.json
    
    - name: Start CloudWatch Agent
      systemd:
        name: amazon-cloudwatch-agent
        state: started
        enabled: yes
